<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Token Login Prototype</title>
  <link href="https://stuff.webmaker.org/makerstrap/latest/makerstrap.complete.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">

    <h1 class="welcome">Welcome, <span class="username"></span></h1>

    <div class="panel panel-default">
      <div class="panel-body">
        <form role="form">
          <div class="form-group">
            <label for="email-token-request">Email address</label>
            <input type="email" class="form-control" id="email-token-request" placeholder="Enter email">
          </div>
          <div class="form-group">
            <button type="button" class="btn btn-primary request">Request Token</button>
          </div>
          <div class="form-group">
            <label for="one-time-token">One-Time Login Token</label>
            <input type="password" class="form-control" id="one-time-token" placeholder="Login Token">
          </div>
          <button type="button" class="btn btn-primary login">Login</button>
        </form>
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-body">
        <form role="form">
          <button type="button" class="btn btn-warning logout">Logout</button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://login.persona.org/include.js"></script>
  <script src="../bower_components/eventEmitter/EventEmitter.js"></script>
  <script src="../bower_components/cookie-js/cookie.js"></script>
  <script>
    var _gaq = {
      push: function(args) {
        console.log("analytics event: ", args);
      }
    };
  </script>
  <script src="../bower_components/webmaker-analytics/analytics.js"></script>
  <script src="../webmaker-auth-client.js"></script>
  <script>
    var requestBtn = document.querySelector('.request')
    var loginBtn = document.querySelector('.login');
    var logoutBtn = document.querySelector('.logout');
    var usernameEl = document.querySelector('.username');

    var requestTokenEmailInput = document.querySelector('#email-token-request');
    var tokenInput = document.querySelector('#one-time-token');

    var auth = new WebmakerAuthClient();

    auth.on('tokenrequested', function(data, message) {
      alert("Token sent to email (or more likely, logged in wmlogin console)!!")
    });

    auth.on('tokenlogin', function(data, message) {
      console.log('tokenlogin', data, message);
      usernameEl.innerHTML = data.email;
    });

    auth.on('logout', function() {
      console.log('logout');
      usernameEl.innerHTML = '';
    });

    auth.on('error', function(err) {
      console.log(err);
    });

    auth.verify();

    requestBtn.addEventListener('click', function() {
      auth.request(requestTokenEmailInput.value);
    });

    loginBtn.addEventListener('click', function() {
      auth.authenticateToken(requestTokenEmailInput.value, tokenInput.value);
    }, false);

    logoutBtn.addEventListener('click', auth.logout, false);

  </script>

</body>
</html>
